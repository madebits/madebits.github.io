#Using i3wm on Lubuntu

2014-02-04

<!--- tags: linux -->

[i3](http://i3wm.org/) is a tiling *window manager*. I am using i3 since a few days now. It takes a bit to get used to, but it has its own bright sides, especially if you program using different applications, you can very easy switch in deterministic ways through the windows. To use i3 effectively you have to learn the few default keyboard shortcuts, and define a few more of your own.

##Getting Started

To install i3wm in Lubuntu use `sudo apt-get install i3`. You may not get the latest version, but the current version in repositories (4.5) is still ok. You can switch which window manager to use at the login screen. In LXDE you can change OpenBox to something else, but I wanted to test `i3` in a separate login session.

On first the login, i3 asks to generate a default configuration when started by using the template in `/etc/i3/config`. The configuration is placed in `~/.i3/config` file. Unlike default Lubuntu, an i3 login does not start anything from LXDE by default. You can start applications at startup, by editing `~/.i3/confi` file. I wanted first not to start `lxsession` to have a raw experience, but I found out that that prevented some stuff from working, so I ended up starting `lxsession`. `lxsession` also starts `lxpanel`, and `pcmanfm` desktop.

i3 commands in configuration file can be re-run at any time via `i3-msg` tool, so you are not limited only at startup automation. My current complete i3 config generated and modified file is listed below (thought it is a bit too long :).

```
# This file has been auto-generated by i3-config-wizard(1).
# It will not be overwritten, so edit it as you like.
#
# Should you change your keyboard layout somewhen, delete
# this file and re-run i3-config-wizard(1).
#

# i3 config file (v4)
#
# Please see http://i3wm.org/docs/userguide.html for a complete reference!

set $mod Mod4

# Font for window titles. Will also be used by the bar unless a different font
# is used in the bar {} block below. ISO 10646 = Unicode
font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
# The font above is very space-efficient, that is, it looks good, sharp and
# clear in small sizes. If you need a lot of unicode glyphs or
# right-to-left text rendering, you should instead use pango for rendering and
# chose a FreeType font, such as:
# font pango:DejaVu Sans Mono 10

font pango: Ubuntu Mono 11

# Use Mouse+$mod to drag floating windows to their wanted position
floating_modifier $mod

# start a terminal
bindsym $mod+Return exec i3-sensible-terminal

# kill focused window
bindsym $mod+Shift+q kill
bindsym $mod+F4 kill

# start dmenu (a program launcher)
# bindsym $mod+d exec dmenu_run
# There also is the (new) i3-dmenu-desktop which only displays applications
# shipping a .desktop file. It is a wrapper around dmenu, so you need that
# installed.
bindsym $mod+d exec --no-startup-id i3-dmenu-desktop

# change focus
bindsym $mod+j focus left
bindsym $mod+k focus down
bindsym $mod+l focus up
bindsym $mod+odiaeresis focus right

# alternatively, you can use the cursor keys:
bindsym $mod+Left focus left
bindsym $mod+Down focus down
bindsym $mod+Up focus up
bindsym $mod+Right focus right

# move focused window
bindsym $mod+Shift+j move left
bindsym $mod+Shift+k move down
bindsym $mod+Shift+l move up
bindsym $mod+Shift+odiaeresis move right

# alternatively, you can use the cursor keys:
bindsym $mod+Shift+Left move left
bindsym $mod+Shift+Down move down
bindsym $mod+Shift+Up move up
bindsym $mod+Shift+Right move right

# split in horizontal orientation
bindsym $mod+h split h

# split in vertical orientation
bindsym $mod+v split v

# enter fullscreen mode for the focused container
bindsym $mod+f fullscreen

# change container layout (stacked, tabbed, toggle split)
bindsym $mod+s layout stacking
bindsym $mod+w layout tabbed
bindsym $mod+e layout toggle split

# toggle tiling / floating
bindsym $mod+Shift+space floating toggle

# change focus between tiling / floating windows
bindsym $mod+space focus mode_toggle

# focus the parent container
bindsym $mod+a focus parent

# focus the child container
#bindsym $mod+d focus child

# switch to workspace
bindsym $mod+1 workspace 1
bindsym $mod+2 workspace 2
bindsym $mod+3 workspace 3
bindsym $mod+4 workspace 4
bindsym $mod+5 workspace 5
bindsym $mod+6 workspace 6
bindsym $mod+7 workspace 7
bindsym $mod+8 workspace 8
bindsym $mod+9 workspace 9
bindsym $mod+0 workspace 10

# move focused container to workspace
bindsym $mod+Shift+1 move container to workspace 1
bindsym $mod+Shift+2 move container to workspace 2
bindsym $mod+Shift+3 move container to workspace 3
bindsym $mod+Shift+4 move container to workspace 4
bindsym $mod+Shift+5 move container to workspace 5
bindsym $mod+Shift+6 move container to workspace 6
bindsym $mod+Shift+7 move container to workspace 7
bindsym $mod+Shift+8 move container to workspace 8
bindsym $mod+Shift+9 move container to workspace 9
bindsym $mod+Shift+0 move container to workspace 10

# reload the configuration file
bindsym $mod+Shift+c reload
# restart i3 inplace (preserves your layout/session, can be used to upgrade i3)
bindsym $mod+Shift+r restart
# exit i3 (logs you out of your X session)
bindsym $mod+Shift+e exec "i3-nagbar -t warning -m 'You pressed the exit shortcut. Do you really want to exit i3? This will end your X session.' -b 'Yes, exit i3' 'i3-msg exit'"

# resize window (you can also use the mouse for that)
mode "resize" {
        # These bindings trigger as soon as you enter the resize mode

        # Pressing left will shrink the window’s width.
        # Pressing right will grow the window’s width.
        # Pressing up will shrink the window’s height.
        # Pressing down will grow the window’s height.
        bindsym j resize shrink width 10 px or 10 ppt
        bindsym k resize grow height 10 px or 10 ppt
        bindsym l resize shrink height 10 px or 10 ppt
        bindsym odiaeresis resize grow width 10 px or 10 ppt

        # same bindings, but for the arrow keys
        bindsym Left resize shrink width 10 px or 10 ppt
        bindsym Down resize grow height 10 px or 10 ppt
        bindsym Up resize shrink height 10 px or 10 ppt
        bindsym Right resize grow width 10 px or 10 ppt

        # back to normal: Enter or Escape
        bindsym Return mode "default"
        bindsym Escape mode "default"
}

bindsym $mod+r mode "resize"

# Start i3bar to display a workspace bar (plus the system information i3status
# finds out, if available)
bar {
	output LVDS
        status_command i3status --config /home/user/.i3/i3status.conf
	#lxpanel
	tray_output none
}

bar {
	output HDMI-0
        status_command i3status --config /home/user/.i3/i3status.conf
	mode hide
	#lxpanel
	tray_output none
}

#bindsym $mod+t border normal
#bindsym $mod+y border 1pixel
#bindsym $mod+u border none

client.focused          #4c7899 #d15600 #ffffff #2e9ef4

#xprop http://i3wm.org/docs/userguide.html#command_criteria
for_window [class="(?i)xfce4-notifyd"] floating enable move container to workspace 1

bindsym XF86AudioRaiseVolume exec amixer -q set Master 2dB+ unmute
bindsym XF86AudioLowerVolume exec amixer -q set Master 2dB- unmute
bindsym XF86AudioMute exec amixer -q set Master toggle

# Make the currently focused window a scratchpad
bindsym $mod+Shift+minus move scratchpad
# Show the first scratchpad window
bindsym $mod+minus scratchpad show

set $mode_system System (l) lock, (e) logout, (r) reboot, (Shift+s) shutdown
mode "$mode_system" {
    bindsym l exec --no-startup-id i3exit lock, mode "default"
    bindsym e exec --no-startup-id i3exit logout, mode "default"
    bindsym r exec --no-startup-id i3exit reboot, mode "default"
    bindsym Shift+s exec --no-startup-id i3exit halt, mode "default"  

    # back to normal: Enter or Escape
    bindsym Return mode "default"
    bindsym Escape mode "default"
}
bindsym $mod+Pause mode "$mode_system"

bindsym $mod+t exec lxtask
bindsym $mod+b exec pcmanfm
bindsym $mod+z exec chromium-browser

exec setxkbmap en
exec setxkbmap -option grp:alt_shift_toggle us,de

for_window [class="(?i)pcmanfm"] move container to workspace 3
exec --no-startup-id  lxsession -s Lubuntu -e LXDE

exec --no-startup-id  /usr/bin/feh --bg-scale "/home/d7/Pictures/Street Lights.png"
exec --no-startup-id clipit

exec --no-startup-id i3-msg 'workspace 1; layout tabbed'
exec --no-startup-id i3-msg 'workspace 2; layout tabbed'

exec --no-startup-id i3-msg 'workspace 1; exec /usr/bin/terminator'
exec --no-startup-id i3-msg 'workspace 2; exec /usr/bin/chromium-browser'
```

You may wish to compare it to the default generated one to see all changes. As I have two monitors, I start some programs in the different workspaces. For chromium-browser, I selected 'Use system title bar and borders' in the settings. From the ArchWiki, I am using the `i3exit` script to logout or shutdown (I put it to my `~/bin` folder). I do not use suspend or hibernate, so I have removed these options, and I modified the ArchWiki `i3exit` script as follows, to make it work in Lubuntu:

```
#!/bin/sh

#https://bbs.archlinux.org/viewtopic.php?id=127962
#https://wiki.archlinux.org/index.php/i3#Shutdown.2C_reboot.2C_lock_screen

lock() {
    i3lock -c 111111
}

case "$1" in
    lock)
        lock
        ;;
    logout)
        i3-msg exit
        ;;
    reboot)
        dbus-send --system --print-reply --dest="org.freedesktop.ConsoleKit" /org/freedesktop/ConsoleKit/Manager org.freedesktop.ConsoleKit.Manager.Restart
        ;;
    halt)
        dbus-send --system --print-reply --dest="org.freedesktop.ConsoleKit" /org/freedesktop/ConsoleKit/Manager org.freedesktop.ConsoleKit.Manager.Stop
        ;;
    *)
        echo "Usage: $0 {lock|logout|reboot|halt}"
        exit 2
esac

exit 0
```
`i3lock` above is a nice lock screen that comes with i3.

My configuration file for the `i3status` stored in `/home/user/.i3/i3status.conf` looks as follows. This i3status file is pretty standard, the biggest change I did was to use the correct battery path for my machine.



```
general {
        colors = true
	color_good = '#88b090'
	color_degraded = '#ccdc90'
	color_bad = '#e89393'
        interval = 5
}

order += "wireless wlan0"
order += "disk /"
order += "volume master"
order += "cpu_temperature 0"
order += "cpu_usage"
order += "battery 0"
order += "time"

wireless wlan0 {
          format_up = "W: (%quality at %essid, %bitrate) %ip"
          format_down = "W: down"
}

battery 0 {
        format = " Bat: %status %percentage "
        path = "/sys/class/power_supply/BAT0/uevent"
}

time {
        format = " %Y-%m-%d %H:%M "
}

volume master {
        format = " Vol: %volume "
        device = "default"
        mixer = "Master"
        mixer_idx = 0
}

cpu_temperature 0 {
        format = " Temp: %degrees°C " 
}

cpu_usage {
        format = " CPU: %usage "
}

disk "/" {
                   format = " %free (%avail) / %total"
}
```

i3 nesting of window containers takes some tome to get used to. I find myself repeating some `$mod+Shift+arrow` keys until I rearrange the windows as I like, and in the end it works. Thought I am never sure how I managed that. i3 seems like a very nice WM, and I think I will spend some more time with it and wait and see how it can handle all my computing needs in the future.

##Getting Serious

The above method to run i3 on Lubuntu works, but it is not the only way. This is how the process tree looks with the above method:

```
init  
...
  ├─lightdm
  │   ├─Xorg -core :0 -auth /var/run/lightdm/root/:0 -nolisten tcp vt7 -novtswitch
  │   │   └─{Xorg}
  │   ├─lightdm --session-child 12 85
  │   │   ├─i3
...
  │   │   └─{lightdm}
  │   └─2*[{lightdm}]
  ├─lxsession -s Lubuntu -e LXDE
...
  │   ├─lxpanel --profile Lubuntu
  │   │   └─4*[{lxpanel}]
...
  │   └─3*[{lxsession}]
...
```
There are four different methods to run i3 in Lubuntu:

1. Start i3 by selecting it at login, and do not start lxsession from i3. This method works ok, but but as soon as you want to use something that relies on freedesktop features, such as polkit, they fail. Getting this configuration to work in all cases is too much evolved.
1. Same as above, but start lxsession from i3 config file. This is what I showed in the original post. I used lxsession with same session id as Lubuntu uses. This has the benefit of sharing some of configuration, but on the other hand you cannot customize the lxsession for i3 alone.
1. Same as above, start i3, and start lxsession from i3 but give to lxsession another new session id and configure it. This method I did not test, but it should work same the one above. I tested the new lxsession id with the next method.
1. Start an lxsession with a new session id, but tell lxsession to use i3 and not Openbox. This method works better in my opinion and I will explain it next.

This is what process tree we will achieve for the last method:
```
init
  │  
...
  ├─lightdm
  │   ├─Xorg -core :0 -auth /var/run/lightdm/root/:0 -nolisten tcp vt7 -novtswitch
  │   │   └─{Xorg}
  │   ├─lightdm --session-child 12 79
  │   │   ├─lxsession -s i3Lubuntu -e LXDE
  │   │   │   ├─i3 -c /home/user/.i3/configlx
  │   │   │   ├─pcmanfm --desktop --profile lubuntu
  │   │   │   │   └─2*[{pcmanfm}]
...
  │   │   │   └─2*[{lxsession}]
  │   │   └─{lightdm}
  │   └─2*[{lightdm}]
...
```

The benefit of this approach is that we reuse `lxsession` as foreseen in LXDE to start the window manager (and not vice-versa). We reuse also the usual Lubuntu `lxsession` autostart functionality and do not need to rely on i3 exec more than it is necessary. We can also easy choose whether we want a `lxpanel` or not.

To create a new `lightdm` login session configuration, I created in `/usr/share/xsessions` a new file called `i3Lubuntu.desktop` with this content:

```
[Desktop Entry]
Name=i3Lubuntu
Comment=i3Lubuntu
Exec=/usr/bin/lxsession -s i3Lubuntu -e LXDE
Type=Application
```
Then in `/etc/xdg/lxsession` I made a copy of the existing `Lubuntu` folder, naming it `i3Lubuntu` (see http://wiki.lxde.org/en/LXSession#Configuration_files).

I edited first `desktop.conf` in the new folder and replaced `openbox` with `i3` and left panel command empty as I do not want to use `lxpanel`.

```
windows_manager/command=i3
windows_manager/session=i3Lubuntu
windows_manager/extras=

panel/command=
panel/session=
```
After this, the new `i3Lubuntu` entry is available for selection at Lubuntu lighdm login screen. `lxsession` fails to start `i3` like this for some reason unknown to me as of now. To fix that, I added in `/etc/xdg/lxsession/i3Lubuntu/autostart`:

```
@/usr/bin/i3
```

I found out that once you login once using i3Lubuntu the settings from `/etc/xdg/lxsession/i3Lubuntu/` are no more used. Instead a copy of them in `~/.config/lxsession/i3Lubuntu` is used. So if you want to some changes after the first login, you have to do them in `~/.config/lxsession/i3Lubuntu` folder.

This setup worked (I had to comment starting of `lxsession` in `~/.i3/config` to test). That is, lightdm starts lxsession, and lxsession starts i3, as part of its autostart. i3 can additionally start other stuff if needed using exec in its `~/.i3/config` file.

To make this finally work, some changes in `~/.i3/config` shown above are needed. I made a copy of `~/.i3/config` as `~/.i3/configlx` and changed `~/.config/lxsession/i3Lubuntu/autostart` to pass the alternative config to i3:

```
@/usr/bin/i3 -c /home/user/.i3/configlx
```

The first thing to configure in i3, as I already mentioned, is not to start `lxsession` from `~/.i3/configlx`. For my first monitor's i3bar, I commented out `#tray_output none` as I want the tray icons show up there, as I am not using `lxpanel` in this configuration.

Given i3 is started from lxsession, simply killing i3 does not exit now the lxsession. This means `i3-msg exit` does not work in the scenario. To fix that in `~/.i3/configlx` I changed:

```
#bindsym $mod+Shift+e exec "i3-nagbar -t warning -m 'You pressed the exit shortcut. Do you really want to exit i3? This will end your X session.' -b 'Yes, exit i3' 'i3-msg exit'"
bindsym $mod+Shift+e exec "i3-nagbar -t warning -m 'You pressed the exit shortcut. Do you really want to exit i3? This will end your X session.' -b 'Yes, exit i3' 'kill -15 $_LXSESSION_PID'"
```

`i3exit` bash script is also affected, so I copied it as `i3exitlx` and replaced there too `i3-msg exit` with `kill -15 $_LXSESSION_PID` (note if `kill -15` does not work for you, use `kill -9`). Then I referred `i3exitlx` in `~/.i3/configlx`.

To easy handle moving of pcmanfm desktop windows I found out these i3 useful commands (I wanted to filter first by class rather by title, but then pcmanfm windows end on workspace 3):

```
bindsym $mod+F1 [title="(?i)pcmanfm"] move workspace current
bindsym $mod+F2 [title="(?i)pcmanfm"] move workspace 3
for_window [title="(?i)pcmanfm"] move container to workspace 3
workspace_auto_back_and_forth yes
bindsym $mod+m move workspace to output right
```

The last one is useful to move an i3 workspace from one monitor to another.

Finally, I bounded the i3 of workspaces I create at startup to my monitors:
```
workspace 1 output LVDS
workspace 2 output HDMI-0
workspace 3 output HDMI-0
```


<ins class='nfooter'><a rel='prev' id='fprev' href='#blog/2014/2014-02-05-Adding-Custom-XML-to-app.config.md'>Adding Custom XML to app.config</a> <a rel='next' id='fnext' href='#blog/2014/2014-01-30-Bash-Cycle-Through-Autocomplete-Options.md'>Bash Cycle Through Autocomplete Options</a></ins>
